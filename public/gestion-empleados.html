<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados - Hackless</title>
    <link rel="stylesheet" href="css/hackless-global.css">
    <link rel="stylesheet" href="css/gestion-empleados.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-users"></i> Gestión de Empleados</h1>
                <p>Sistema de alta y administración de personal</p>
            </div>
            
            <!-- Content -->
            <div class="content">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/escritorio.html">Dashboard</a></li>
                        <li class="breadcrumb-item active">Empleados</li>
                    </ol>
                </nav>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalEmpleados">-</div>
                        <div class="stat-label">Total Empleados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="empleadosActivos">-</div>
                        <div class="stat-label">Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="empleadosInactivos">-</div>
                        <div class="stat-label">Inactivos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nuevosEmpleados">-</div>
                        <div class="stat-label">Nuevos (30d)</div>
                    </div>
                </div>
                
                <!-- Action Cards -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="action-card">
                            <h3><i class="fas fa-download"></i> Descargar Plantillas</h3>
                            <p class="text-muted mb-3">Descarga plantillas de Excel para gestionar empleados de forma masiva.</p>
                            <button class="btn btn-custom btn-download" onclick="descargarExcelDemo()">
                                <i class="fas fa-file-excel"></i> Plantilla con Ejemplos
                            </button>
                            <button class="btn btn-custom btn-template" onclick="descargarPlantillaVacia()">
                                <i class="fas fa-file-alt"></i> Plantilla Vacía
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="action-card">
                            <h3><i class="fas fa-upload"></i> Carga Masiva</h3>
                            <p class="text-muted mb-3">Sube un archivo Excel con datos de empleados para procesamiento masivo.</p>
                            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <h5>Haz clic para seleccionar archivo</h5>
                                <p class="text-muted">o arrastra un archivo Excel aquí</p>
                                <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input-hidden" title="Seleccionar archivo Excel para importar empleados">
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-custom btn-upload" onclick="procesarArchivo()">
                                    <i class="fas fa-cogs"></i> Procesar Archivo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empleados Table -->
                <div class="action-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-list"></i> Lista de Empleados</h3>
                        <div>
                            <button class="btn btn-custom btn-template btn-sm" onclick="window.location.href='/alta-empleado.html'">
                                <i class="fas fa-user-plus"></i> Nuevo Empleado
                            </button>
                            <button class="btn btn-custom btn-template btn-sm" onclick="exportarEmpleados()">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                            <button class="btn btn-custom btn-download btn-sm" onclick="actualizarLista()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="filtroEstado" title="Filtrar por estado de empleado">
                                <option value="">Todos los estados</option>
                                <option value="activo">Activos</option>
                                <option value="inactivo">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroRol" title="Filtrar por rol de empleado">
                                <option value="">Todos los roles</option>
                                <option value="administrador">Administrador</option>
                                <option value="operativo">Operativo</option>
                                <option value="auditor">Auditor</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="rrhh">RRHH</option>
                                <option value="seguridad_higiene">Seguridad e Higiene</option>
                                <option value="empleado">Empleado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="filtroNombre" placeholder="Buscar por nombre o email...">
                        </div>
                    </div>
                    
                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Área</th>
                                    <th>Estado</th>
                                    <th>Fecha Ingreso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEmpleados">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
                <p><strong>Hackless TFG</strong> - Sistema de Gestión Documental</p>
                <small>Desarrollado por Verónica García</small>
            </div>
        </div>
    </div>
    
    <!-- Alerts Container -->
    <div id="alertsContainer" class="alerts-container"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let empleados = [];
        let archivoSeleccionado = null;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticas();
            cargarEmpleados();
            configurarEventos();
        });
        
        // Configurar eventos
        function configurarEventos() {
            // Filtros
            document.getElementById('filtroEstado').addEventListener('change', filtrarEmpleados);
            document.getElementById('filtroRol').addEventListener('change', filtrarEmpleados);
            document.getElementById('filtroNombre').addEventListener('input', filtrarEmpleados);
            
            // Upload area
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    archivoSeleccionado = files[0];
                    mostrarArchivoSeleccionado();
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    archivoSeleccionado = e.target.files[0];
                    mostrarArchivoSeleccionado();
                }
            });
        }
        
        // Descargar Excel con ejemplos
        function descargarExcelDemo() {
            mostrarCargando('Generando Excel con ejemplos...');
            window.location.href = '/api/demo/generar-excel-empleados';
            setTimeout(() => {
                mostrarAlerta('Excel con ejemplos descargado correctamente', 'success');
            }, 1000);
        }
        
        // Descargar plantilla vacía
        function descargarPlantillaVacia() {
            mostrarCargando('Generando plantilla vacía...');
            window.location.href = '/api/demo/plantilla-empleados-vacia';
            setTimeout(() => {
                mostrarAlerta('Plantilla vacía descargada correctamente', 'success');
            }, 1000);
        }
        
        // Mostrar archivo seleccionado
        function mostrarArchivoSeleccionado() {
            if (archivoSeleccionado) {
                const uploadArea = document.querySelector('.upload-area');
                uploadArea.innerHTML = `
                    <div class="upload-icon text-success"><i class="fas fa-file-excel"></i></div>
                    <h5 class="text-success">Archivo seleccionado</h5>
                    <p class="text-muted">${archivoSeleccionado.name}</p>
                    <small class="text-muted">${(archivoSeleccionado.size / 1024).toFixed(2)} KB</small>
                `;
            }
        }
        
        // Procesar archivo
        function procesarArchivo() {
            if (!archivoSeleccionado) {
                mostrarAlerta('Por favor selecciona un archivo Excel', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('excel', archivoSeleccionado);
            
            mostrarCargando('Procesando archivo Excel...');
            
            fetch('/users/upload-excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta(`Archivo procesado correctamente. ${data.empleadosCreados} empleados agregados.`, 'success');
                    cargarEmpleados();
                    cargarEstadisticas();
                    resetearUpload();
                } else {
                    mostrarAlerta(data.message || 'Error al procesar el archivo', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al procesar el archivo', 'danger');
            });
        }
        
        // Resetear upload area
        function resetearUpload() {
            archivoSeleccionado = null;
            document.getElementById('fileInput').value = '';
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                <h5>Haz clic para seleccionar archivo</h5>
                <p class="text-muted">o arrastra un archivo Excel aquí</p>
            `;
        }
        
        // Cargar estadísticas
        function cargarEstadisticas() {
            fetch('/users')
            .then(response => response.json())
            .then(data => {
                const total = data.length;
                const activos = data.filter(emp => emp.estado === 'activo').length;
                const inactivos = total - activos;
                const treintaDiasAtras = new Date();
                treintaDiasAtras.setDate(treintaDiasAtras.getDate() - 30);
                const nuevos = data.filter(emp => new Date(emp.created_at) >= treintaDiasAtras).length;
                
                document.getElementById('totalEmpleados').textContent = total;
                document.getElementById('empleadosActivos').textContent = activos;
                document.getElementById('empleadosInactivos').textContent = inactivos;
                document.getElementById('nuevosEmpleados').textContent = nuevos;
            })
            .catch(error => {
                console.error('Error cargando estadísticas:', error);
            });
        }
        
        // Cargar empleados
        function cargarEmpleados() {
            fetch('/users')
            .then(response => response.json())
            .then(data => {
                empleados = data;
                renderizarEmpleados(empleados);
            })
            .catch(error => {
                console.error('Error cargando empleados:', error);
                mostrarAlerta('Error al cargar la lista de empleados', 'danger');
            });
        }
        
        // Renderizar tabla de empleados
        function renderizarEmpleados(empleadosData) {
            const tbody = document.getElementById('tablaEmpleados');
            
            if (empleadosData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <i class="fas fa-users text-muted" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            <p class="text-muted">No hay empleados registrados</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = empleadosData.map(empleado => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                ${empleado.nombre.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="fw-bold">${empleado.nombre}</div>
                                <small class="text-muted">${empleado.puesto || 'Sin puesto'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${empleado.correo_electronico}</td>
                    <td><span class="badge badge-custom bg-info">${empleado.rol}</span></td>
                    <td>${empleado.area || 'Sin área'}</td>
                    <td>
                        <span class="badge badge-custom ${empleado.estado === 'activo' ? 'bg-success' : 'bg-secondary'}">
                            ${empleado.estado}
                        </span>
                    </td>
                    <td>${empleado.fecha_ingreso ? new Date(empleado.fecha_ingreso).toLocaleDateString('es-ES') : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="verEmpleado(${empleado.id_usuario})" title="Ver">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editarEmpleado(${empleado.id_usuario})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="eliminarEmpleado(${empleado.id_usuario})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Filtrar empleados
        function filtrarEmpleados() {
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroRol = document.getElementById('filtroRol').value;
            const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
            
            const empleadosFiltrados = empleados.filter(empleado => {
                const cumpleEstado = !filtroEstado || empleado.estado === filtroEstado;
                const cumpleRol = !filtroRol || empleado.rol === filtroRol;
                const cumpleNombre = !filtroNombre || 
                    empleado.nombre.toLowerCase().includes(filtroNombre) ||
                    empleado.correo_electronico.toLowerCase().includes(filtroNombre);
                
                return cumpleEstado && cumpleRol && cumpleNombre;
            });
            
            renderizarEmpleados(empleadosFiltrados);
        }
        
        // Actualizar lista
        function actualizarLista() {
            mostrarCargando('Actualizando lista...');
            cargarEmpleados();
            cargarEstadisticas();
            setTimeout(() => {
                mostrarAlerta('Lista actualizada correctamente', 'success');
            }, 500);
        }
        
        // Exportar empleados
        function exportarEmpleados() {
            mostrarCargando('Exportando empleados...');
            // Aquí iría la lógica para exportar los empleados filtrados
            setTimeout(() => {
                mostrarAlerta('Exportación completada', 'success');
            }, 1000);
        }
        
        // Acciones de empleados (placeholder)
        function verEmpleado(id) {
            mostrarAlerta(`Ver empleado ID: ${id}`, 'info');
        }
        
        function editarEmpleado(id) {
            mostrarAlerta(`Editar empleado ID: ${id}`, 'info');
        }
        
        function eliminarEmpleado(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este empleado?')) {
                mostrarAlerta(`Empleado ID: ${id} eliminado`, 'warning');
            }
        }
        
        // Utilidades
        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${tipo} alert-dismissible fade show alert-custom" role="alert" id="${alertId}">
                    <i class="fas fa-${getIconByType(tipo)}"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss después de 5 segundos
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        function mostrarCargando(mensaje) {
            mostrarAlerta(`<span class="spinner-border spinner-border-sm me-2"></span>${mensaje}`, 'info');
        }
        
        function getIconByType(tipo) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle'
            };
            return icons[tipo] || 'info-circle';
        }
    </script>
</body>
</html>

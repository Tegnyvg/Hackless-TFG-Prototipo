<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠as Internas - Hackless</title>
    <link rel="stylesheet" href="css/hackless-global.css">
    <link rel="stylesheet" href="css/auditorias.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-area" onclick="window.location.href='index.html'">
            <img src="images/logoescudo.png" alt="Hackless Logo">
            <span>HACKLESS</span>
        </div>
        <a href="escritorio.html" class="back-btn">üè† Volver al Escritorio</a>
    </div>

    <div class="container">
        <h1 class="page-title">üîç Sistema de Auditor√≠as Internas</h1>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('planificar')">üìÖ Planificar Auditor√≠a</button>
                <button class="tab-button" onclick="showTab('ejecutar')">‚ö° Ejecutar Auditor√≠a</button>
                <button class="tab-button" onclick="showTab('lista')">üìã Ver Auditor√≠as</button>
                <button class="tab-button" onclick="showTab('reportes')">üìä Reportes</button>
            </div>
        </div>

        <!-- TAB: PLANIFICAR AUDITOR√çA -->
        <div id="tab-planificar" class="tab-content active">
            <div class="section">
                <h2 class="section-title">
                    üìÖ Planificar Nueva Auditor√≠a
                </h2>
                <form id="auditoriaPlanForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipo_auditoria">Tipo de Auditor√≠a <span class="required">*</span></label>
                            <select id="tipo_auditoria" name="tipo_auditoria" required>
                                <option value="">-- Seleccione tipo --</option>
                                <option value="iso_27001">ISO 27001 - Seguridad de la Informaci√≥n</option>
                                <option value="hse">HSE - Salud, Seguridad y Ambiente</option>
                                <option value="calidad">Calidad - ISO 9001</option>
                                <option value="compliance">Compliance Regulatorio</option>
                                <option value="operacional">Auditor√≠a Operacional</option>
                                <option value="financiera">Auditor√≠a Financiera</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fecha_programada">Fecha Programada <span class="required">*</span></label>
                            <input type="date" id="fecha_programada" name="fecha_programada" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="auditor_responsable">Auditor Responsable <span class="required">*</span></label>
                            <select id="auditor_responsable" name="auditor_responsable" required>
                                <option value="">-- Seleccione auditor --</option>
                                <option value="interno">Auditor Interno</option>
                                <option value="externo">Auditor Externo</option>
                                <option value="equipo">Equipo de Auditor√≠a</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="area_auditada">√Årea a Auditar <span class="required">*</span></label>
                            <select id="area_auditada" name="area_auditada" required>
                                <option value="">-- Seleccione √°rea --</option>
                                <option value="operaciones">Operaciones</option>
                                <option value="seguridad">Seguridad e Higiene</option>
                                <option value="rrhh">Recursos Humanos</option>
                                <option value="ti">Tecnolog√≠a de la Informaci√≥n</option>
                                <option value="calidad">Gesti√≥n de Calidad</option>
                                <option value="finanzas">Finanzas</option>
                                <option value="ingenieria">Ingenier√≠a</option>
                                <option value="legal">Legal y Compliance</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="alcance">Alcance de la Auditor√≠a <span class="required">*</span></label>
                            <textarea id="alcance" name="alcance" required 
                                      placeholder="Defina claramente el alcance, los procesos, sistemas o √°reas espec√≠ficas que ser√°n evaluadas en esta auditor√≠a."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="objetivos">Objetivos de la Auditor√≠a</label>
                            <textarea id="objetivos" name="objetivos" 
                                      placeholder="Especifique los objetivos espec√≠ficos que se buscan lograr con esta auditor√≠a."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="estado_auditoria">Estado <span class="required">*</span></label>
                            <select id="estado_auditoria" name="estado_auditoria" required>
                                <option value="planificada">üìÖ Planificada</option>
                                <option value="en_progreso">‚ö° En Progreso</option>
                                <option value="completada">‚úÖ Completada</option>
                                <option value="cancelada">‚ùå Cancelada</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="prioridad">Prioridad <span class="required">*</span></label>
                            <select id="prioridad" name="prioridad" required>
                                <option value="baja">üü¢ Baja</option>
                                <option value="media">üü° Media</option>
                                <option value="alta">üî¥ Alta</option>
                                <option value="critica">üö® Cr√≠tica</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">üìÖ Planificar Auditor√≠a</button>
                    <div id="planificarMessage" class="message hidden"></div>
                </form>
            </div>
        </div>

        <!-- TAB: EJECUTAR AUDITOR√çA -->
        <div id="tab-ejecutar" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    ‚ö° Ejecutar Auditor√≠a
                </h2>
                
                <!-- Selector de Auditor√≠a Planificada -->
                <div class="audit-selector">
                    <div class="form-group">
                        <label for="auditoria_select">Seleccionar Auditor√≠a Planificada</label>
                        <select id="auditoria_select" name="auditoria_select">
                            <option value="">-- Cargar auditor√≠as planificadas --</option>
                        </select>
                        <button type="button" id="cargarAuditoria" class="btn-secondary">üîÑ Cargar Auditor√≠as</button>
                    </div>
                </div>
                
                <!-- Formulario de Ejecuci√≥n -->
                <form id="auditoriaEjecucionForm" class="execution-form hidden">
                    <div class="audit-info">
                        <h3>üìã Informaci√≥n de la Auditor√≠a</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Tipo:</span>
                                <span id="info-tipo" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">√Årea:</span>
                                <span id="info-area" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Fecha:</span>
                                <span id="info-fecha" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Responsable:</span>
                                <span id="info-responsable" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fecha_real">Fecha Real de Ejecuci√≥n <span class="required">*</span></label>
                            <input type="date" id="fecha_real" name="fecha_real" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="duracion">Duraci√≥n (horas) <span class="required">*</span></label>
                            <input type="number" id="duracion" name="duracion" min="0.5" step="0.5" required 
                                   placeholder="Ej: 4.5">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="metodologia">Metodolog√≠a Aplicada</label>
                            <select id="metodologia" name="metodologia">
                                <option value="">-- Seleccione metodolog√≠a --</option>
                                <option value="checklist">Lista de Verificaci√≥n (Checklist)</option>
                                <option value="entrevistas">Entrevistas Estructuradas</option>
                                <option value="observacion">Observaci√≥n Directa</option>
                                <option value="revision_documentos">Revisi√≥n de Documentos</option>
                                <option value="muestreo">T√©cnicas de Muestreo</option>
                                <option value="mixta">Metodolog√≠a Mixta</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="hallazgos_encontrados">Hallazgos Identificados</label>
                            <textarea id="hallazgos_encontrados" name="hallazgos_encontrados" 
                                      placeholder="Registre todos los hallazgos, observaciones y no conformidades identificadas durante la auditor√≠a."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="recomendaciones">Recomendaciones y Acciones Correctivas</label>
                            <textarea id="recomendaciones" name="recomendaciones" 
                                      placeholder="Describa las recomendaciones y acciones correctivas propuestas para abordar los hallazgos."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="resultado_general">Resultado General <span class="required">*</span></label>
                            <select id="resultado_general" name="resultado_general" required>
                                <option value="">-- Seleccione resultado --</option>
                                <option value="satisfactorio">‚úÖ Satisfactorio</option>
                                <option value="satisfactorio_observaciones">‚ö†Ô∏è Satisfactorio con Observaciones</option>
                                <option value="no_conforme_menor">üü° No Conforme Menor</option>
                                <option value="no_conforme_mayor">üî¥ No Conforme Mayor</option>
                                <option value="no_satisfactorio">‚ùå No Satisfactorio</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="puntuacion">Puntuaci√≥n (0-100)</label>
                            <input type="number" id="puntuacion" name="puntuacion" min="0" max="100" 
                                   placeholder="Puntuaci√≥n num√©rica si aplica">
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">‚ö° Completar Auditor√≠a</button>
                    <div id="ejecutarMessage" class="message hidden"></div>
                </form>
            </div>
        </div>

        <!-- TAB: LISTA DE AUDITOR√çAS -->
        <div id="tab-lista" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    üìã Auditor√≠as Registradas
                </h2>
                
                <!-- Filtros -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="filtro-estado">Filtrar por Estado:</label>
                        <select id="filtro-estado">
                            <option value="">Todos los estados</option>
                            <option value="planificada">Planificadas</option>
                            <option value="en_progreso">En Progreso</option>
                            <option value="completada">Completadas</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filtro-tipo">Filtrar por Tipo:</label>
                        <select id="filtro-tipo">
                            <option value="">Todos los tipos</option>
                            <option value="iso_27001">ISO 27001</option>
                            <option value="hse">HSE</option>
                            <option value="calidad">Calidad</option>
                            <option value="compliance">Compliance</option>
                            <option value="operacional">Operacional</option>
                            <option value="financiera">Financiera</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filtro-fecha">Desde Fecha:</label>
                        <input type="date" id="filtro-fecha">
                    </div>
                    
                    <button id="refreshAuditorias" class="refresh-btn">üîÑ Actualizar Lista</button>
                    <button id="exportarAuditorias" class="export-btn">üìä Exportar Excel</button>
                </div>
                
                <div id="auditoriasList" class="auditorias-list">
                    <p class="loading">Cargando auditor√≠as...</p>
                </div>
            </div>
        </div>

        <!-- TAB: REPORTES -->
        <div id="tab-reportes" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    üìä Reportes y M√©tricas de Auditor√≠a
                </h2>
                
                <!-- Dashboard de M√©tricas -->
                <div class="metrics-dashboard">
                    <div class="metric-card">
                        <div class="metric-icon">üìÖ</div>
                        <div class="metric-content">
                            <div class="metric-number" id="total-auditorias">0</div>
                            <div class="metric-label">Total Auditor√≠as</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">‚ö°</div>
                        <div class="metric-content">
                            <div class="metric-number" id="auditorias-progreso">0</div>
                            <div class="metric-label">En Progreso</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">‚úÖ</div>
                        <div class="metric-content">
                            <div class="metric-number" id="auditorias-completadas">0</div>
                            <div class="metric-label">Completadas</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">üìà</div>
                        <div class="metric-content">
                            <div class="metric-number" id="promedio-puntuacion">0%</div>
                            <div class="metric-label">Promedio de Cumplimiento</div>
                        </div>
                    </div>
                </div>
                
                <!-- Generador de Reportes -->
                <div class="report-generator">
                    <h3>üéØ Generar Reportes Personalizados</h3>
                    <form id="reporteForm" class="reporte-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="reporte-tipo">Tipo de Reporte:</label>
                                <select id="reporte-tipo" name="reporte-tipo" required>
                                    <option value="">-- Seleccione tipo --</option>
                                    <option value="ejecutivo">Reporte Ejecutivo</option>
                                    <option value="detallado">Reporte Detallado</option>
                                    <option value="compliance">Reporte de Compliance</option>
                                    <option value="tendencias">An√°lisis de Tendencias</option>
                                    <option value="hallazgos">Reporte de Hallazgos</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="reporte-periodo">Per√≠odo:</label>
                                <select id="reporte-periodo" name="reporte-periodo" required>
                                    <option value="">-- Seleccione per√≠odo --</option>
                                    <option value="ultimo_mes">√öltimo Mes</option>
                                    <option value="ultimo_trimestre">√öltimo Trimestre</option>
                                    <option value="ultimo_semestre">√öltimo Semestre</option>
                                    <option value="ultimo_a√±o">√öltimo A√±o</option>
                                    <option value="personalizado">Per√≠odo Personalizado</option>
                                </select>
                            </div>
                            
                            <div class="form-group periodo-personalizado hidden">
                                <label for="fecha-desde">Desde:</label>
                                <input type="date" id="fecha-desde" name="fecha-desde">
                            </div>
                            
                            <div class="form-group periodo-personalizado hidden">
                                <label for="fecha-hasta">Hasta:</label>
                                <input type="date" id="fecha-hasta" name="fecha-hasta">
                            </div>
                        </div>
                        
                        <div class="reporte-actions">
                            <button type="submit" class="btn-primary">üìä Generar Reporte</button>
                            <button type="button" id="previewReporte" class="btn-secondary">üëÅÔ∏è Vista Previa</button>
                        </div>
                    </form>
                    
                    <div id="reporteMessage" class="message hidden"></div>
                </div>
                
                <!-- √Årea de Resultados del Reporte -->
                <div id="reporteResultados" class="reporte-resultados hidden">
                    <h3>üìã Resultado del Reporte</h3>
                    <div id="reporteContent" class="reporte-content">
                        <!-- Contenido del reporte se carga aqu√≠ -->
                    </div>
                    
                    <div class="reporte-actions">
                        <button id="descargarPDF" class="btn-primary">üìÑ Descargar PDF</button>
                        <button id="descargarExcel" class="btn-secondary">üìä Descargar Excel</button>
                        <button id="enviarEmail" class="btn-secondary">üìß Enviar por Email</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Variables globales
        let auditoriaSeleccionada = null;
        let auditoriasData = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            configurarEventos();
            configurarValidaciones();
            cargarDatosIniciales();
        });

        // Configurar eventos
        function configurarEventos() {
            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showTab(tabName);
                });
            });

            // Formularios
            document.getElementById('auditoriaPlanForm').addEventListener('submit', planificarAuditoria);
            document.getElementById('auditoriaEjecucionForm').addEventListener('submit', ejecutarAuditoria);
            document.getElementById('reporteForm').addEventListener('submit', generarReporte);

            // Botones
            document.getElementById('cargarAuditoria').addEventListener('click', cargarAuditoriasPlanificadas);
            document.getElementById('refreshAuditorias').addEventListener('click', cargarListaAuditorias);
            document.getElementById('exportarAuditorias').addEventListener('click', exportarAuditorias);
            document.getElementById('previewReporte').addEventListener('click', previsualizarReporte);

            // Selectores
            document.getElementById('auditoria_select').addEventListener('change', seleccionarAuditoria);
            document.getElementById('reporte-periodo').addEventListener('change', togglePeriodoPersonalizado);

            // Filtros
            document.getElementById('filtro-estado').addEventListener('change', filtrarAuditorias);
            document.getElementById('filtro-tipo').addEventListener('change', filtrarAuditorias);
            document.getElementById('filtro-fecha').addEventListener('change', filtrarAuditorias);

            // Configurar fecha m√≠nima para planificaci√≥n (hoy)
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_programada').min = hoy;
            document.getElementById('fecha_real').max = hoy;
        }

        // Funci√≥n para cambiar tabs
        function showTab(tabName) {
            // Ocultar todas las tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar tab seleccionada
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos del tab
            if (tabName === 'lista') {
                cargarListaAuditorias();
            } else if (tabName === 'reportes') {
                cargarMetricas();
            }
        }

        // Planificar auditor√≠a
        async function planificarAuditoria(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const auditoriaData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/auditorias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(auditoriaData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarMensaje('planificarMessage', '‚úÖ Auditor√≠a planificada exitosamente', 'success');
                    event.target.reset();
                } else {
                    mostrarMensaje('planificarMessage', '‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('planificarMessage', '‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Cargar auditor√≠as planificadas
        async function cargarAuditoriasPlanificadas() {
            try {
                const response = await fetch('/api/auditorias?estado=planificada');
                const result = await response.json();
                
                const select = document.getElementById('auditoria_select');
                select.innerHTML = '<option value="">-- Seleccione auditor√≠a --</option>';
                
                if (result.success && result.data.length > 0) {
                    result.data.forEach(auditoria => {
                        const option = document.createElement('option');
                        option.value = auditoria.id;
                        option.textContent = `${auditoria.tipo_auditoria} - ${auditoria.area_auditada} (${auditoria.fecha_programada})`;
                        option.dataset.auditoria = JSON.stringify(auditoria);
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay auditor√≠as planificadas</option>';
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('ejecutarMessage', '‚ùå Error al cargar auditor√≠as', 'error');
            }
        }

        // Seleccionar auditor√≠a para ejecutar
        function seleccionarAuditoria(event) {
            const selectedOption = event.target.selectedOptions[0];
            const form = document.getElementById('auditoriaEjecucionForm');
            
            if (selectedOption && selectedOption.dataset.auditoria) {
                auditoriaSeleccionada = JSON.parse(selectedOption.dataset.auditoria);
                
                // Mostrar informaci√≥n de la auditor√≠a
                document.getElementById('info-tipo').textContent = auditoriaSeleccionada.tipo_auditoria;
                document.getElementById('info-area').textContent = auditoriaSeleccionada.area_auditada;
                document.getElementById('info-fecha').textContent = auditoriaSeleccionada.fecha_programada;
                document.getElementById('info-responsable').textContent = auditoriaSeleccionada.auditor_responsable;
                
                // Mostrar formulario
                form.classList.remove('hidden');
                
                // Configurar fecha real con la fecha programada como sugerencia
                document.getElementById('fecha_real').value = auditoriaSeleccionada.fecha_programada;
            } else {
                form.classList.add('hidden');
                auditoriaSeleccionada = null;
            }
        }

        // Ejecutar auditor√≠a
        async function ejecutarAuditoria(event) {
            event.preventDefault();
            
            if (!auditoriaSeleccionada) {
                mostrarMensaje('ejecutarMessage', '‚ùå Debe seleccionar una auditor√≠a primero', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            const ejecucionData = Object.fromEntries(formData);
            ejecucionData.id_auditoria = auditoriaSeleccionada.id;
            
            try {
                const response = await fetch('/api/auditorias/ejecutar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ejecucionData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarMensaje('ejecutarMessage', '‚úÖ Auditor√≠a ejecutada exitosamente', 'success');
                    event.target.reset();
                    document.getElementById('auditoriaEjecucionForm').classList.add('hidden');
                    cargarAuditoriasPlanificadas(); // Recargar lista
                } else {
                    mostrarMensaje('ejecutarMessage', '‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('ejecutarMessage', '‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Cargar lista de auditor√≠as
        async function cargarListaAuditorias() {
            try {
                const response = await fetch('/api/auditorias');
                const result = await response.json();
                
                if (result.success) {
                    auditoriasData = result.data;
                    renderizarListaAuditorias(auditoriasData);
                } else {
                    document.getElementById('auditoriasList').innerHTML = '<p class="error">Error al cargar auditor√≠as</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('auditoriasList').innerHTML = '<p class="error">Error de conexi√≥n</p>';
            }
        }

        // Renderizar lista de auditor√≠as
        function renderizarListaAuditorias(auditorias) {
            const container = document.getElementById('auditoriasList');
            
            if (auditorias.length === 0) {
                container.innerHTML = '<p class="no-data">No hay auditor√≠as registradas</p>';
                return;
            }
            
            let html = '<div class="auditorias-grid">';
            
            auditorias.forEach(auditoria => {
                const estadoClass = getEstadoClass(auditoria.estado_auditoria);
                const prioridadIcon = getPrioridadIcon(auditoria.prioridad);
                
                html += `
                    <div class="auditoria-card ${estadoClass}">
                        <div class="auditoria-header">
                            <div class="auditoria-tipo">${auditoria.tipo_auditoria}</div>
                            <div class="auditoria-prioridad">${prioridadIcon}</div>
                        </div>
                        <div class="auditoria-content">
                            <div class="auditoria-area"><strong>√Årea:</strong> ${auditoria.area_auditada}</div>
                            <div class="auditoria-fecha"><strong>Fecha:</strong> ${auditoria.fecha_programada || auditoria.fecha_real}</div>
                            <div class="auditoria-responsable"><strong>Responsable:</strong> ${auditoria.auditor_responsable}</div>
                            <div class="auditoria-estado">
                                <span class="estado-badge ${estadoClass}">${auditoria.estado_auditoria}</span>
                            </div>
                        </div>
                        <div class="auditoria-actions">
                            <button onclick="verDetalleAuditoria(${auditoria.id})" class="btn-detail">üëÅÔ∏è Ver</button>
                            ${auditoria.estado_auditoria === 'completada' ? 
                                `<button onclick="generarReporteAuditoria(${auditoria.id})" class="btn-report">üìä Reporte</button>` : 
                                `<button onclick="editarAuditoria(${auditoria.id})" class="btn-edit">‚úèÔ∏è Editar</button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Funciones auxiliares para renderizado
        function getEstadoClass(estado) {
            const clases = {
                'planificada': 'estado-planificada',
                'en_progreso': 'estado-progreso',
                'completada': 'estado-completada',
                'cancelada': 'estado-cancelada'
            };
            return clases[estado] || '';
        }

        function getPrioridadIcon(prioridad) {
            const iconos = {
                'baja': 'üü¢',
                'media': 'üü°',
                'alta': 'üî¥',
                'critica': 'üö®'
            };
            return iconos[prioridad] || '‚ö™';
        }

        // Filtrar auditor√≠as
        function filtrarAuditorias() {
            const estado = document.getElementById('filtro-estado').value;
            const tipo = document.getElementById('filtro-tipo').value;
            const fecha = document.getElementById('filtro-fecha').value;
            
            let auditoriasFiltradas = auditoriasData;
            
            if (estado) {
                auditoriasFiltradas = auditoriasFiltradas.filter(a => a.estado_auditoria === estado);
            }
            
            if (tipo) {
                auditoriasFiltradas = auditoriasFiltradas.filter(a => a.tipo_auditoria === tipo);
            }
            
            if (fecha) {
                auditoriasFiltradas = auditoriasFiltradas.filter(a => {
                    const fechaAuditoria = a.fecha_programada || a.fecha_real;
                    return fechaAuditoria >= fecha;
                });
            }
            
            renderizarListaAuditorias(auditoriasFiltradas);
        }

        // Cargar m√©tricas
        async function cargarMetricas() {
            try {
                const response = await fetch('/api/auditorias/metricas');
                const result = await response.json();
                
                if (result.success) {
                    const metricas = result.data;
                    document.getElementById('total-auditorias').textContent = metricas.total || 0;
                    document.getElementById('auditorias-progreso').textContent = metricas.en_progreso || 0;
                    document.getElementById('auditorias-completadas').textContent = metricas.completadas || 0;
                    document.getElementById('promedio-puntuacion').textContent = (metricas.promedio_puntuacion || 0) + '%';
                }
            } catch (error) {
                console.error('Error al cargar m√©tricas:', error);
            }
        }

        // Toggle per√≠odo personalizado
        function togglePeriodoPersonalizado() {
            const periodo = document.getElementById('reporte-periodo').value;
            const campos = document.querySelectorAll('.periodo-personalizado');
            
            if (periodo === 'personalizado') {
                campos.forEach(campo => campo.classList.remove('hidden'));
            } else {
                campos.forEach(campo => campo.classList.add('hidden'));
            }
        }

        // Generar reporte
        async function generarReporte(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const reporteData = Object.fromEntries(formData);
            
            try {
                // Mostrar indicador de carga
                const submitBtn = event.target.querySelector('.btn-primary');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Generando...';
                submitBtn.disabled = true;
                
                // Simular tiempo de procesamiento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generar contenido del reporte basado en el tipo
                const reporteContent = generarContenidoReporte(reporteData);
                
                document.getElementById('reporteResultados').classList.remove('hidden');
                document.getElementById('reporteContent').innerHTML = reporteContent;
                
                // Scrollear al resultado
                document.getElementById('reporteResultados').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
                mostrarMensaje('reporteMessage', '‚úÖ Reporte generado exitosamente', 'success');
                
                // Restaurar bot√≥n
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('reporteMessage', '‚ùå Error al generar el reporte', 'error');
                
                // Restaurar bot√≥n
                const submitBtn = event.target.querySelector('.btn-primary');
                submitBtn.textContent = 'üìä Generar Reporte';
                submitBtn.disabled = false;
            }
        }

        // Generar contenido del reporte
        function generarContenidoReporte(datos) {
            const tipo = datos['reporte-tipo'];
            const periodo = datos['reporte-periodo'];
            
            const reportes = {
                ejecutivo: generarReporteEjecutivo(periodo),
                detallado: generarReporteDetallado(periodo),
                compliance: generarReporteCompliance(periodo),
                tendencias: generarReporteTendencias(periodo),
                hallazgos: generarReporteHallazgos(periodo)
            };
            
            return reportes[tipo] || generarReporteDefault(periodo);
        }

        // Generar reporte ejecutivo
        function generarReporteEjecutivo(periodo) {
            return `
                <div class="reporte-header">
                    <h2>üìä Reporte Ejecutivo de Auditor√≠as</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                    <p><strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div class="reporte-seccion">
                    <h3>üéØ Resumen Ejecutivo</h3>
                    <div class="estadisticas-grid">
                        <div class="stat-box">
                            <div class="stat-numero">8</div>
                            <div class="stat-texto">Auditor√≠as Realizadas</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-numero">92%</div>
                            <div class="stat-texto">Nivel de Cumplimiento</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-numero">15</div>
                            <div class="stat-texto">Hallazgos Identificados</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-numero">85%</div>
                            <div class="stat-texto">Acciones Completadas</div>
                        </div>
                    </div>
                </div>
                
                <div class="reporte-seccion">
                    <h3>üìà Indicadores Clave</h3>
                    <ul class="indicadores-lista">
                        <li><strong>Tiempo promedio de auditor√≠a:</strong> 3.2 d√≠as</li>
                        <li><strong>√Åreas m√°s auditadas:</strong> Seguridad (35%), Calidad (28%), HSE (22%)</li>
                        <li><strong>Tendencia de cumplimiento:</strong> +5% vs per√≠odo anterior</li>
                        <li><strong>Riesgo cr√≠tico:</strong> 2 hallazgos identificados y cerrados</li>
                    </ul>
                </div>
                
                <div class="reporte-seccion">
                    <h3>üí° Recomendaciones</h3>
                    <ol class="recomendaciones-lista">
                        <li>Implementar programa de auditor√≠as preventivas trimestrales</li>
                        <li>Fortalecer el √°rea de TI con auditor√≠as espec√≠ficas de ciberseguridad</li>
                        <li>Establecer KPIs automatizados para seguimiento continuo</li>
                    </ol>
                </div>
            `;
        }

        // Generar reporte detallado
        function generarReporteDetallado(periodo) {
            return `
                <div class="reporte-header">
                    <h2>üìã Reporte Detallado de Auditor√≠as</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                </div>
                
                <div class="auditorias-detalle">
                    <div class="auditoria-item">
                        <h4>üîê Auditor√≠a ISO 27001 - Seguridad de la Informaci√≥n</h4>
                        <p><strong>Fecha:</strong> 15/06/2025 | <strong>Estado:</strong> Completada</p>
                        <p><strong>Auditor:</strong> Mar√≠a Gonz√°lez | <strong>Puntuaci√≥n:</strong> 94%</p>
                        <p><strong>Hallazgos:</strong> 3 menores, 0 mayores</p>
                        <div class="acciones-correctivas">
                            <p><strong>Acciones correctivas:</strong></p>
                            <ul>
                                <li>Actualizar pol√≠tica de contrase√±as ‚úÖ</li>
                                <li>Implementar autenticaci√≥n de dos factores ‚úÖ</li>
                                <li>Revisar logs de acceso semanalmente üîÑ</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="auditoria-item">
                        <h4>üè≠ Auditor√≠a HSE - Seguridad Industrial</h4>
                        <p><strong>Fecha:</strong> 22/06/2025 | <strong>Estado:</strong> Completada</p>
                        <p><strong>Auditor:</strong> Carlos Mendoza | <strong>Puntuaci√≥n:</strong> 88%</p>
                        <p><strong>Hallazgos:</strong> 4 menores, 1 mayor</p>
                        <div class="acciones-correctivas">
                            <p><strong>Acciones correctivas:</strong></p>
                            <ul>
                                <li>Reemplazar equipos de protecci√≥n obsoletos ‚úÖ</li>
                                <li>Capacitaci√≥n adicional en manejo de qu√≠micos üîÑ</li>
                                <li>Instalar se√±alizaci√≥n de emergencia ‚úÖ</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="auditoria-item">
                        <h4>‚öôÔ∏è Auditor√≠a Operacional - Procesos</h4>
                        <p><strong>Fecha:</strong> 28/06/2025 | <strong>Estado:</strong> En progreso</p>
                        <p><strong>Auditor:</strong> Ana Rodr√≠guez | <strong>Progreso:</strong> 75%</p>
                        <p><strong>√Åreas revisadas:</strong> 6 de 8 procesos cr√≠ticos</p>
                    </div>
                </div>
            `;
        }

        // Generar reporte de compliance
        function generarReporteCompliance(periodo) {
            return `
                <div class="reporte-header">
                    <h2>‚öñÔ∏è Reporte de Compliance Regulatorio</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                </div>
                
                <div class="compliance-seccion">
                    <h3>üìã Estado de Cumplimiento Normativo</h3>
                    <div class="normativas-grid">
                        <div class="normativa-card">
                            <h4>ISO 27001:2013</h4>
                            <div class="compliance-nivel nivel-alto">95% Cumplimiento</div>
                            <p>Certificaci√≥n vigente hasta: Marzo 2026</p>
                        </div>
                        <div class="normativa-card">
                            <h4>ISO 9001:2015</h4>
                            <div class="compliance-nivel nivel-alto">92% Cumplimiento</div>
                            <p>Pr√≥xima auditor√≠a: Agosto 2025</p>
                        </div>
                        <div class="normativa-card">
                            <h4>OHSAS 18001</h4>
                            <div class="compliance-nivel nivel-medio">87% Cumplimiento</div>
                            <p>Requiere mejoras en 3 √°reas</p>
                        </div>
                        <div class="normativa-card">
                            <h4>Ley de Datos Personales</h4>
                            <div class="compliance-nivel nivel-alto">96% Cumplimiento</div>
                            <p>√öltima revisi√≥n: Mayo 2025</p>
                        </div>
                    </div>
                </div>
                
                <div class="compliance-acciones">
                    <h3>üéØ Acciones Requeridas</h3>
                    <div class="accion-item critica">
                        <strong>üî¥ Cr√≠tica:</strong> Actualizar procedimientos de evacuaci√≥n (OHSAS 18001)
                        <span class="fecha-limite">Fecha l√≠mite: 30/07/2025</span>
                    </div>
                    <div class="accion-item media">
                        <strong>üü° Media:</strong> Revisi√≥n de pol√≠tica de acceso a datos
                        <span class="fecha-limite">Fecha l√≠mite: 15/08/2025</span>
                    </div>
                    <div class="accion-item baja">
                        <strong>üü¢ Baja:</strong> Actualizaci√≥n de manual de calidad
                        <span class="fecha-limite">Fecha l√≠mite: 30/08/2025</span>
                    </div>
                </div>
            `;
        }

        // Generar reporte de tendencias
        function generarReporteTendencias(periodo) {
            return `
                <div class="reporte-header">
                    <h2>üìà An√°lisis de Tendencias</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                </div>
                
                <div class="tendencias-seccion">
                    <h3>üìä Evoluci√≥n del Cumplimiento</h3>
                    <div class="tendencia-grafico">
                        <div class="mes-data">
                            <div class="mes">Enero</div>
                            <div class="barra" style="height: 85%;">85%</div>
                        </div>
                        <div class="mes-data">
                            <div class="mes">Febrero</div>
                            <div class="barra" style="height: 88%;">88%</div>
                        </div>
                        <div class="mes-data">
                            <div class="mes">Marzo</div>
                            <div class="barra" style="height: 90%;">90%</div>
                        </div>
                        <div class="mes-data">
                            <div class="mes">Abril</div>
                            <div class="barra" style="height: 87%;">87%</div>
                        </div>
                        <div class="mes-data">
                            <div class="mes">Mayo</div>
                            <div class="barra" style="height: 92%;">92%</div>
                        </div>
                        <div class="mes-data">
                            <div class="mes">Junio</div>
                            <div class="barra" style="height: 94%;">94%</div>
                        </div>
                    </div>
                </div>
                
                <div class="insights-seccion">
                    <h3>üîç Insights Clave</h3>
                    <ul class="insights-lista">
                        <li><strong>Tendencia positiva:</strong> +9% de mejora en los √∫ltimos 6 meses</li>
                        <li><strong>Mejor √°rea:</strong> Seguridad de la Informaci√≥n (96% promedio)</li>
                        <li><strong>√Årea de oportunidad:</strong> HSE requiere atenci√≥n (87% promedio)</li>
                        <li><strong>Frecuencia √≥ptima:</strong> Auditor√≠as mensuales muestran mejor rendimiento</li>
                        <li><strong>Tiempo de resoluci√≥n:</strong> Reducci√≥n del 25% en cierre de hallazgos</li>
                    </ul>
                </div>
            `;
        }

        // Generar reporte de hallazgos
        function generarReporteHallazgos(periodo) {
            return `
                <div class="reporte-header">
                    <h2>üîç Reporte de Hallazgos</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                </div>
                
                <div class="hallazgos-resumen">
                    <h3>üìä Resumen de Hallazgos</h3>
                    <div class="hallazgos-stats">
                        <div class="hallazgo-stat critico">
                            <div class="numero">3</div>
                            <div class="tipo">Cr√≠ticos</div>
                        </div>
                        <div class="hallazgo-stat mayor">
                            <div class="numero">8</div>
                            <div class="tipo">Mayores</div>
                        </div>
                        <div class="hallazgo-stat menor">
                            <div class="numero">15</div>
                            <div class="tipo">Menores</div>
                        </div>
                        <div class="hallazgo-stat observacion">
                            <div class="numero">12</div>
                            <div class="tipo">Observaciones</div>
                        </div>
                    </div>
                </div>
                
                <div class="hallazgos-detalle">
                    <h3>üìã Detalle de Hallazgos Cr√≠ticos</h3>
                    <div class="hallazgo-item critico">
                        <h4>üî¥ HAL-001: Falta de backup de seguridad</h4>
                        <p><strong>√Årea:</strong> TI | <strong>Fecha:</strong> 15/06/2025</p>
                        <p><strong>Descripci√≥n:</strong> Sistema cr√≠tico sin respaldo autom√°tico configurado</p>
                        <p><strong>Acci√≥n correctiva:</strong> Implementar backup diario ‚úÖ Completado</p>
                    </div>
                    
                    <div class="hallazgo-item critico">
                        <h4>üî¥ HAL-002: Procedimiento de evacuaci√≥n desactualizado</h4>
                        <p><strong>√Årea:</strong> HSE | <strong>Fecha:</strong> 22/06/2025</p>
                        <p><strong>Descripci√≥n:</strong> Planos de evacuaci√≥n no reflejan nueva distribuci√≥n</p>
                        <p><strong>Acci√≥n correctiva:</strong> Actualizar se√±alizaci√≥n üîÑ En progreso</p>
                    </div>
                    
                    <div class="hallazgo-item mayor">
                        <h4>üü° HAL-003: Capacitaci√≥n pendiente</h4>
                        <p><strong>√Årea:</strong> RRHH | <strong>Fecha:</strong> 28/06/2025</p>
                        <p><strong>Descripci√≥n:</strong> 15% del personal sin capacitaci√≥n actualizada</p>
                        <p><strong>Acci√≥n correctiva:</strong> Programar sesiones de julio ‚è∞ Programado</p>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para obtener texto del per√≠odo
        function getPeriodoTexto(periodo) {
            const periodos = {
                'ultimo_mes': '√öltimo Mes',
                'ultimo_trimestre': '√öltimo Trimestre', 
                'ultimo_semestre': '√öltimo Semestre',
                'ultimo_a√±o': '√öltimo A√±o',
                'personalizado': 'Per√≠odo Personalizado'
            };
            return periodos[periodo] || 'Per√≠odo no especificado';
        }

        // Reporte por defecto
        function generarReporteDefault(periodo) {
            return `
                <div class="reporte-header">
                    <h2>üìä Reporte de Auditor√≠as</h2>
                    <p><strong>Per√≠odo:</strong> ${getPeriodoTexto(periodo)}</p>
                </div>
                <p>Reporte generado exitosamente. Los datos est√°n siendo procesados.</p>
            `;
        }

        // Funciones de utilidad
        function mostrarMensaje(elementId, mensaje, tipo) {
            const element = document.getElementById(elementId);
            element.textContent = mensaje;
            element.className = `message ${tipo}`;
            element.classList.remove('hidden');
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function configurarValidaciones() {
            // Validaciones adicionales si es necesario
        }

        function cargarDatosIniciales() {
            // Configurar fecha actual por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_real').value = hoy;
        }

        // Funciones para acciones espec√≠ficas (a implementar seg√∫n necesidades)
        function verDetalleAuditoria(id) {
            // Implementar vista detalle
            console.log('Ver detalle de auditor√≠a:', id);
        }

        function editarAuditoria(id) {
            // Implementar edici√≥n
            console.log('Editar auditor√≠a:', id);
        }

        function generarReporteAuditoria(id) {
            // Generar reporte espec√≠fico para una auditor√≠a
            const auditoria = auditoriasData.find(a => a.id === id);
            if (!auditoria) {
                alert('Auditor√≠a no encontrada');
                return;
            }
            
            // Cambiar a la pesta√±a de reportes
            showTab('reportes');
            
            // Generar contenido espec√≠fico de la auditor√≠a
            const reporteContent = `
                <div class="reporte-header">
                    <h2>üìã Reporte Individual de Auditor√≠a</h2>
                    <h3>${auditoria.tipo} - ${auditoria.area}</h3>
                    <p><strong>ID:</strong> ${auditoria.id} | <strong>Fecha:</strong> ${auditoria.fecha}</p>
                </div>
                
                <div class="auditoria-detalle-completo">
                    <div class="seccion-info">
                        <h4>üìä Informaci√≥n General</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>Auditor Responsable:</strong> ${auditoria.auditor}
                            </div>
                            <div class="info-item">
                                <strong>Estado Actual:</strong> 
                                <span class="estado-badge ${auditoria.estado.toLowerCase()}">${auditoria.estado}</span>
                            </div>
                            <div class="info-item">
                                <strong>Puntuaci√≥n de Cumplimiento:</strong> ${auditoria.puntuacion}%
                            </div>
                            <div class="info-item">
                                <strong>Duraci√≥n:</strong> ${auditoria.duracion || '3 d√≠as'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="seccion-alcance">
                        <h4>üéØ Alcance y Objetivos</h4>
                        <p><strong>Alcance:</strong> ${auditoria.alcance || 'Evaluaci√≥n integral de procesos y controles del √°rea especificada'}</p>
                        <p><strong>Objetivos:</strong> Verificar cumplimiento normativo, identificar oportunidades de mejora y evaluar eficacia de controles internos</p>
                    </div>
                    
                    <div class="seccion-hallazgos">
                        <h4>üîç Hallazgos Identificados</h4>
                        <div class="hallazgos-lista">
                            <div class="hallazgo-item menor">
                                <strong>HAL-${id}01:</strong> Documentaci√≥n de procesos requiere actualizaci√≥n
                                <div class="accion">Acci√≥n: Revisar y actualizar manuales - üìÖ Vence: 30/07/2025</div>
                            </div>
                            <div class="hallazgo-item menor">
                                <strong>HAL-${id}02:</strong> Capacitaci√≥n del personal en nuevos procedimientos
                                <div class="accion">Acci√≥n: Programar sesi√≥n de entrenamiento - üìÖ Vence: 15/08/2025</div>
                            </div>
                            ${auditoria.estado === 'Completada' ? `
                                <div class="hallazgo-item observacion">
                                    <strong>OBS-${id}01:</strong> Oportunidad de automatizaci√≥n en reportes
                                    <div class="accion">Recomendaci√≥n: Evaluar herramientas de automatizaci√≥n</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="seccion-conclusiones">
                        <h4>üìù Conclusiones y Recomendaciones</h4>
                        <div class="conclusion-box">
                            <p><strong>Conclusi√≥n General:</strong> El √°rea auditada demuestra un nivel ${auditoria.puntuacion >= 90 ? 'excelente' : auditoria.puntuacion >= 80 ? 'bueno' : 'aceptable'} de cumplimiento. Los hallazgos identificados son de impacto menor y las acciones correctivas est√°n en proceso de implementaci√≥n.</p>
                            
                            <div class="recomendaciones">
                                <p><strong>Recomendaciones Principales:</strong></p>
                                <ul>
                                    <li>Mantener el programa de auditor√≠as internas con frecuencia trimestral</li>
                                    <li>Implementar las acciones correctivas en los plazos establecidos</li>
                                    <li>Considerar la automatizaci√≥n de procesos repetitivos</li>
                                    <li>Reforzar la cultura de mejora continua en el equipo</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="reporte-firma">
                    <div class="firma-auditor">
                        <p><strong>Auditor Responsable:</strong></p>
                        <p>${auditoria.auditor}</p>
                        <p>Fecha: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            
            // Mostrar el reporte
            document.getElementById('reporteResultados').classList.remove('hidden');
            document.getElementById('reporteContent').innerHTML = reporteContent;
            
            // Scrollear al resultado
            setTimeout(() => {
                document.getElementById('reporteResultados').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }, 100);
        }

        function exportarAuditorias() {
            // Implementar exportaci√≥n
            window.open('/api/auditorias/export', '_blank');
        }

        function previsualizarReporte() {
            // Implementar vista previa
            console.log('Vista previa del reporte');
        }
    </script>
</body>
</html>

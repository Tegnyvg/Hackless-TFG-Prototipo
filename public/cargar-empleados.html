<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Completa de Empleados - Hackless</title>
    <link rel="stylesheet" href="css/hackless-global.css">
    <link rel="stylesheet" href="css/cargar-empleados.css">
    <style>
        /* Modo oscuro armonizado */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ecf0f1;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .top-nav {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .logo-area:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        .logo-area img {
            height: 36px;
            width: 36px;
            margin-right: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .logo-area span {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        
        .top-nav a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            margin-left: 8px;
            font-weight: 500;
        }
        
        .top-nav a:hover {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            transform: translateY(-1px);
        }
        
        .upload-container {
            max-width: 1000px;
            margin: 30px auto;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-section h1 {
            color: #ecf0f1;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .header-section p {
            color: #bdc3c7;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        /* Estilos para las pestañas */
        .tabs-container {
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .tab-button {
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: #bdc3c7;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab-button:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* Contenido de pestañas */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Secciones de contenido */
        .template-download,
        .instructions,
        .upload-section {
            background: rgba(52, 73, 94, 0.6);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .template-download h3,
        .instructions h3,
        .upload-section h3 {
            color: #ecf0f1;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .btn-template {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 8px;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-template:hover {
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        /* Input de archivo personalizado */
        .file-input-wrapper {
            margin: 20px 0;
        }
        
        .file-input-label {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            font-size: 1.1rem;
        }
        
        .file-input-label:hover {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        /* Información del archivo */
        .file-info {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ecf0f1;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Botón de upload */
        .upload-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }
        
        .upload-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .upload-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Sección de progreso */
        .progress-section {
            background: rgba(52, 73, 94, 0.8);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-section h4 {
            color: #ecf0f1;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .progress-bar {
            background: rgba(44, 62, 80, 0.8);
            border-radius: 25px;
            padding: 3px;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .progress-fill {
            height: 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 20px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }
        
        #progressText {
            color: #bdc3c7;
            font-style: italic;
            margin-top: 10px;
        }
        
        /* Sección de resultados */
        .results-section {
            background: rgba(52, 73, 94, 0.8);
            padding: 30px;
            border-radius: 12px;
            margin: 25px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .results-section h3 {
            color: #ecf0f1;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.4rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #ecf0f1;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Formularios */
        .manual-form {
            background: rgba(52, 73, 94, 0.6);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group label {
            display: block;
            color: #ecf0f1;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(44, 62, 80, 0.8);
            color: #ecf0f1;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }
        
        .form-group input::placeholder {
            color: #95a5a6;
        }
        
        /* Instrucciones */
        .instructions ul {
            color: #bdc3c7;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .form-instructions {
            background: rgba(52, 73, 94, 0.6);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-instructions h3 {
            color: #ecf0f1;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .form-instructions p {
            color: #bdc3c7;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        /* Utilidades */
        .text-center {
            text-align: center;
        }
        
        .margin-top-20 {
            margin-top: 20px;
        }
        
        /* Botones principales */
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
    </style>
</head>
<body>
<!-- Copilot: Página de carga masiva de empleados para RRHH - Permite subir archivos Excel
     con datos de empleados y procesar la información para registro automático en el sistema. -->

    <div class="top-nav">
        <div class="logo-area" onclick="window.location.href='index.html'">
            <img src="images/logoescudo.png" alt="Hackless Logo">
            <span>HACKLESS</span>
        </div>
        <div>
            <a href="escritorio.html">📊 Escritorio</a>
            <a href="nomina.html">👥 Ver Nómina</a>
        </div>
    </div>

    <div class="upload-container">
        <div class="header-section">
            <h1>👥 Gestión Completa de Empleados - RRHH</h1>
            <p>Carga masiva, registro manual, modificación y eliminación de empleados</p>
        </div>

        <!-- Pestañas para alternar entre funcionalidades -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('masiva', event)">📤 Carga Masiva (Excel)</button>
                <button class="tab-button" onclick="showTab('manual', event)">✏️ Alta Manual</button>
                <button class="tab-button" onclick="showTab('modificar', event)">✏️ Modificar Empleado</button>
                <button class="tab-button" onclick="showTab('eliminar', event)">🗑️ Eliminar Empleado</button>
            </div>
        </div>

        <!-- TAB: CARGA MASIVA -->
        <div id="tab-masiva" class="tab-content active">

        <div class="template-download">
            <h3>📋 Descargar Plantilla</h3>
            <p>Utiliza nuestra plantilla para asegurar el formato correcto de los datos</p>
            <a href="#" class="btn-template" onclick="downloadTemplate()">📥 Descargar Plantilla Excel</a>
            <a href="#" class="btn-template" onclick="downloadSample()">👥 Datos de Ejemplo</a>
        </div>

        <div class="instructions">
            <h3>📝 Instrucciones de Uso</h3>
            <ul>
                <li><strong>Formato requerido:</strong> Archivo Excel (.xlsx) o CSV</li>
                <li><strong>Columnas obligatorias:</strong> Nombre, DNI, Email, Rol</li>
                <li><strong>DNI:</strong> Debe tener exactamente 8 dígitos numéricos</li>
                <li><strong>Columnas opcionales:</strong> Puesto, Area, Telefono</li>
                <li><strong>Validaciones:</strong> Email único, DNI único, formato válido</li>
                <li><strong>Contraseña temporal:</strong> Se asigna automáticamente (Hackless2025!)</li>
            </ul>
        </div>

        <div class="upload-section">
            <h3>📤 Seleccionar Archivo</h3>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
                <label for="fileInput" class="file-input-label">
                    📁 Hacer clic para seleccionar archivo Excel
                </label>
            </div>
            <div id="fileInfo" class="file-info hidden"></div>
            <button id="uploadBtn" class="upload-btn" onclick="uploadFile()" disabled>
                🚀 Procesar y Cargar Empleados
            </button>
        </div>

        <div id="progressSection" class="progress-section hidden">
            <h4>⏳ Procesando archivo...</h4>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p id="progressText">Preparando...</p>
        </div>

        <div id="resultsSection" class="results-section hidden">
            <h3 id="resultsTitle">📊 Resultados de la Carga</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div id="totalProcessed" class="stat-number">0</div>
                    <div class="stat-label">Total Procesados</div>
                </div>
                <div class="stat-item">
                    <div id="successCount" class="stat-number">0</div>
                    <div class="stat-label">Empleados Creados</div>
                </div>
                <div class="stat-item">
                    <div id="existingCount" class="stat-number">0</div>
                    <div class="stat-label">Ya Existían</div>
                </div>
                <div class="stat-item">
                    <div id="errorCount" class="stat-number">0</div>
                    <div class="stat-label">Errores</div>
                </div>
            </div>
            <div id="resultsDetails"></div>
            <div class="text-center margin-top-20">
                <a href="nomina.html" class="btn-template">👥 Ver Nómina Actualizada</a>
            </div>
        </div>

        <!-- TAB: CARGA MANUAL -->
        <div id="tab-manual" class="tab-content">
            <div class="form-instructions">
                <h3>✏️ Registro Manual de Empleado</h3>
                <p>Complete los datos del nuevo empleado. Los campos marcados con <span class="required">*</span> son obligatorios.</p>
                <p><strong>DNI:</strong> Debe tener exactamente 8 dígitos numéricos.</p>
                <p><strong>Contraseña temporal:</strong> Se asignará automáticamente (Hackless2025!) y podrá ser cambiada en el primer login.</p>
            </div>

            <form id="manualEmployeeForm" class="manual-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre">Nombre Completo <span class="required">*</span></label>
                        <input type="text" id="nombre" name="nombre" required placeholder="Ej: Juan Carlos Pérez">
                    </div>
                    
                    <div class="form-group">
                        <label for="dni">DNI <span class="required">*</span></label>
                        <input type="text" id="dni" name="dni" required placeholder="12345678" 
                               pattern="[0-9]{8}" maxlength="8" title="El DNI debe tener exactamente 8 dígitos">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Correo Electrónico <span class="required">*</span></label>
                        <input type="email" id="email" name="email" required placeholder="empleado@empresa.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="rol">Rol en el Sistema <span class="required">*</span></label>
                        <select id="rol" name="rol" required>
                            <option value="">Seleccionar rol...</option>
                            <option value="empleado">Empleado</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="puesto">Puesto de Trabajo</label>
                        <input type="text" id="puesto" name="puesto" placeholder="Ej: Ingeniero de Producción">
                    </div>
                    
                    <div class="form-group">
                        <label for="area">Área/Departamento</label>
                        <select id="area" name="area">
                            <option value="">Seleccionar área...</option>
                            <option value="Operaciones">Operaciones</option>
                            <option value="HSE">HSE (Salud, Seguridad y Ambiente)</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Administración">Administración</option>
                            <option value="Recursos Humanos">Recursos Humanos</option>
                            <option value="Ingeniería">Ingeniería</option>
                            <option value="Legal">Legal y Compliance</option>
                            <option value="Auditoría">Auditoría</option>
                            <option value="Logística">Logística</option>
                            <option value="Finanzas">Finanzas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="+54 9 11 1234-5678">
                    </div>
                </div>

                <div id="manualPreview" class="employee-preview hidden">
                    <div class="preview-title">👤 Vista Previa del Empleado</div>
                    <div class="preview-grid">
                        <div class="preview-item">
                            <span class="preview-label">Nombre:</span>
                            <span class="preview-value" id="preview-nombre">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">DNI:</span>
                            <span class="preview-value" id="preview-dni">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Email:</span>
                            <span class="preview-value" id="preview-email">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Rol:</span>
                            <span class="preview-value" id="preview-rol">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Puesto:</span>
                            <span class="preview-value" id="preview-puesto">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Área:</span>
                            <span class="preview-value" id="preview-area">-</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Teléfono:</span>
                            <span class="preview-value" id="preview-telefono">-</span>
                        </div>
                    </div>
                </div>

                <button type="submit" id="manualSubmitBtn" class="manual-submit-btn">
                    👤 Crear Empleado
                </button>
            </form>

            <div id="manualResultsSection" class="results-section">
                <h3 id="manualResultsTitle">📊 Resultado del Registro</h3>
                <div id="manualResultsDetails"></div>
                <div class="text-center margin-top-15">
                    <button onclick="resetManualForm()" class="btn-template">➕ Registrar Otro Empleado</button>
                    <a href="nomina.html" class="btn-template">👥 Ver Nómina</a>
                </div>
            </div>
        </div>

        <!-- TAB: MODIFICAR EMPLEADO -->
        <div id="tab-modificar" class="tab-content">
            <div class="form-instructions">
                <h3>✏️ Modificar Empleado</h3>
                <p>Busque el empleado por DNI o nombre y modifique sus datos.</p>
            </div>

            <div class="search-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="buscar_empleado">Buscar Empleado</label>
                        <input type="text" id="buscar_empleado" name="buscar_empleado" placeholder="DNI o nombre del empleado">
                    </div>
                    <div class="form-group">
                        <button type="button" onclick="buscarEmpleado()" class="btn-primary">🔍 Buscar</button>
                    </div>
                </div>
            </div>

            <div id="employee-edit-section" class="hidden">
                <form id="editEmployeeForm" class="manual-form">
                    <input type="hidden" id="edit_employee_id" name="employee_id">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit_nombre">Nombre Completo <span class="required">*</span></label>
                            <input type="text" id="edit_nombre" name="nombre" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_dni">DNI <span class="required">*</span></label>
                            <input type="text" id="edit_dni" name="dni" required pattern="[0-9]{8}" maxlength="8">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_email">Correo Electrónico <span class="required">*</span></label>
                            <input type="email" id="edit_email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_rol">Rol en el Sistema <span class="required">*</span></label>
                            <select id="edit_rol" name="rol" required>
                                <option value="">Seleccionar rol...</option>
                                <option value="empleado">Empleado</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="administrador">Administrador</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_puesto">Puesto de Trabajo</label>
                            <input type="text" id="edit_puesto" name="puesto">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_area">Área</label>
                            <input type="text" id="edit_area" name="area">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_telefono">Teléfono</label>
                            <input type="text" id="edit_telefono" name="telefono">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_estado">Estado</label>
                            <select id="edit_estado" name="estado">
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="cancelarEdicion()" class="btn-secondary">❌ Cancelar</button>
                        <button type="submit" class="btn-primary">💾 Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB: ELIMINAR EMPLEADO -->
        <div id="tab-eliminar" class="tab-content">
            <div class="form-instructions">
                <h3>🗑️ Eliminar Empleado</h3>
                <p class="warning-text">⚠️ Esta acción eliminará permanentemente el empleado del sistema.</p>
                <p>Busque el empleado por DNI o nombre para proceder con la eliminación.</p>
            </div>

            <div class="search-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="buscar_empleado_eliminar">Buscar Empleado</label>
                        <input type="text" id="buscar_empleado_eliminar" name="buscar_empleado_eliminar" placeholder="DNI o nombre del empleado">
                    </div>
                    <div class="form-group">
                        <button type="button" onclick="buscarEmpleadoEliminar()" class="btn-primary">🔍 Buscar</button>
                    </div>
                </div>
            </div>

            <div id="employee-delete-section" class="hidden">
                <div class="employee-info-card">
                    <h4>📋 Información del Empleado</h4>
                    <div id="employee-delete-info"></div>
                    
                    <div class="delete-confirmation">
                        <h5 class="warning-text">⚠️ Confirmación de Eliminación</h5>
                        <p>Escriba <strong>ELIMINAR</strong> para confirmar la acción:</p>
                        <input type="text" id="confirm_delete" name="confirm_delete" placeholder="Escriba ELIMINAR">
                        
                        <div class="form-actions">
                            <button type="button" onclick="cancelarEliminacion()" class="btn-secondary">❌ Cancelar</button>
                            <button type="button" onclick="confirmarEliminacion()" class="btn-danger">🗑️ Eliminar Empleado</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Alertas -->
    <div id="alertsContainer" class="alerts-container"></div>

    <script>
        let selectedFile = null;

        // === FUNCIONES UTILITARIAS PARA VISIBILIDAD ===
        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('hidden');
            }
        }

        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('hidden');
            }
        }

        function toggleElement(elementId, show) {
            if (show) {
                showElement(elementId);
            } else {
                hideElement(elementId);
            }
        }

        // === VALIDACIONES ===
        
        // Validación en tiempo real para DNI
        document.getElementById('dni').addEventListener('input', function(e) {
            const dni = e.target.value;
            
            // Solo permitir números
            e.target.value = dni.replace(/[^0-9]/g, '');
            
            // Límite de 8 dígitos
            if (e.target.value.length > 8) {
                e.target.value = e.target.value.slice(0, 8);
            }
            
            // Validar formato
            const isValid = /^[0-9]{8}$/.test(e.target.value);
            if (e.target.value.length === 8 && !isValid) {
                e.target.setCustomValidity('El DNI debe tener exactamente 8 dígitos');
            } else if (e.target.value.length > 0 && e.target.value.length < 8) {
                e.target.setCustomValidity('El DNI debe tener exactamente 8 dígitos');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // === FUNCIONES PARA PESTAÑAS ===
        function showTab(tabName, event) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Quitar clase active de todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activar botón correspondiente
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: buscar el botón por el nombre de la pestaña
                document.querySelector(`[onclick*="${tabName}"]`).classList.add('active');
            }
        }

        // === FUNCIONES PARA CARGA MASIVA (Excel) ===
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');

            if (selectedFile) {
                showElement('fileInfo');
                fileInfo.innerHTML = `
                    <strong>📄 Archivo seleccionado:</strong> ${selectedFile.name}<br>
                    <strong>📏 Tamaño:</strong> ${(selectedFile.size / 1024).toFixed(2)} KB<br>
                    <strong>📅 Última modificación:</strong> ${new Date(selectedFile.lastModified).toLocaleString('es-AR')}
                `;
                uploadBtn.disabled = false;
            } else {
                hideElement('fileInfo');
                uploadBtn.disabled = true;
            }
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('Por favor selecciona un archivo primero');
                return;
            }

            const formData = new FormData();
            formData.append('excelFile', selectedFile);

            // Mostrar progreso
            showProgress();

            try {
                const response = await fetch('/users/upload-excel', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideProgress();
                showResults(result, response.ok);

            } catch (error) {
                hideProgress();
                showResults({
                    message: 'Error de conexión: ' + error.message,
                    resumen: { totalFilas: 0, usuariosCreados: 0, usuariosExistentes: 0, errores: 1 }
                }, false);
            }
        }

        function showProgress() {
            showElement('progressSection');
            hideElement('resultsSection');
            
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressFill.style.width = progress + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'Leyendo archivo Excel...';
                } else if (progress < 60) {
                    progressText.textContent = 'Validando datos...';
                } else {
                    progressText.textContent = 'Creando usuarios...';
                }
                
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 200);
        }

        function hideProgress() {
            hideElement('progressSection');
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '100%';
        }

        function showResults(result, success) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTitle = document.getElementById('resultsTitle');
            
            showElement('resultsSection');
            resultsSection.className = 'results-section ' + (success ? 'results-success' : 'results-error');
            
            if (success) {
                resultsTitle.textContent = '✅ Carga Completada Exitosamente';
            } else {
                resultsTitle.textContent = '❌ Error en la Carga';
            }

            // Actualizar estadísticas
            if (result.resumen) {
                document.getElementById('totalProcessed').textContent = result.resumen.totalFilas || 0;
                document.getElementById('successCount').textContent = result.resumen.usuariosCreados || 0;
                document.getElementById('existingCount').textContent = result.resumen.usuariosExistentes || 0;
                document.getElementById('errorCount').textContent = result.resumen.errores || 0;
            }

            // Mostrar detalles
            const resultsDetails = document.getElementById('resultsDetails');
            let detailsHTML = `<p><strong>Mensaje:</strong> ${result.message}</p>`;
            
            if (result.contrasenaTemporalInfo) {
                detailsHTML += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>🔑 Información importante:</strong><br>
                        ${result.contrasenaTemporalInfo}
                    </div>
                `;
            }

            if (result.detalleErrores && result.detalleErrores.length > 0) {
                detailsHTML += `
                    <div style="margin-top: 15px;">
                        <strong>📋 Detalles de errores:</strong>
                        <div class="error-list">
                            ${result.detalleErrores.map(error => {
                                let highlight = '';
                                if (error.includes('DNI duplicado')) highlight = 'background: #ffe5e5; color: #c0392b;';
                                if (error.includes('Email duplicado')) highlight = 'background: #fff3cd; color: #b8860b;';
                                if (error.includes('formato')) highlight = 'background: #e5f7ff; color: #2980b9;';
                                return `<div class="error-item" style="${highlight}">⚠️ ${error}</div>`;
                            }).join('')}
                        </div>
                        <div style="margin-top:10px;">
                            <span style="background:#ffe5e5;color:#c0392b;padding:3px 8px;border-radius:4px;">DNI duplicado</span>
                            <span style="background:#fff3cd;color:#b8860b;padding:3px 8px;border-radius:4px;margin-left:8px;">Email duplicado</span>
                            <span style="background:#e5f7ff;color:#2980b9;padding:3px 8px;border-radius:4px;margin-left:8px;">Error de formato</span>
                        </div>
                    </div>
                `;
            }

            resultsDetails.innerHTML = detailsHTML;

            // Limpiar formulario
            document.getElementById('fileInput').value = '';
            hideElement('fileInfo');
            document.getElementById('uploadBtn').disabled = true;
            selectedFile = null;
        }

        // === FUNCIONES PARA CARGA MANUAL ===
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('manualEmployeeForm');
            const inputs = form.querySelectorAll('input, select');
            
            // Actualizar vista previa en tiempo real
            inputs.forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            // Manejar envío del formulario
            form.addEventListener('submit', handleManualSubmit);
        });

        function updatePreview() {
            const form = document.getElementById('manualEmployeeForm');
            const preview = document.getElementById('manualPreview');
            const formData = new FormData(form);
            
            // Mostrar preview solo si hay algún dato
            const hasData = Array.from(formData.values()).some(value => value.trim() !== '');
            
            if (hasData) {
                preview.classList.remove('hidden');
                
                document.getElementById('preview-nombre').textContent = formData.get('nombre') || '-';
                document.getElementById('preview-dni').textContent = formData.get('dni') || '-';
                document.getElementById('preview-email').textContent = formData.get('email') || '-';
                document.getElementById('preview-rol').textContent = formData.get('rol') || '-';
                document.getElementById('preview-puesto').textContent = formData.get('puesto') || '-';
                document.getElementById('preview-area').textContent = formData.get('area') || '-';
                document.getElementById('preview-telefono').textContent = formData.get('telefono') || '-';
            } else {
                preview.classList.add('hidden');
            }
        }

        async function handleManualSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const submitBtn = document.getElementById('manualSubmitBtn');
            const formData = new FormData(form);
            
            // Validar campos requeridos
            if (!formData.get('nombre') || !formData.get('email') || !formData.get('rol')) {
                alert('Por favor complete todos los campos obligatorios (Nombre, Email, Rol)');
                return;
            }
            
            // Deshabilitar botón durante el envío
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Creando empleado...';
            
            try {
                // Preparar datos para el endpoint de registro
                const employeeData = {
                    nombre: formData.get('nombre'),
                    correo_electronico: formData.get('email'),
                    password: 'Hackless2025!', // Contraseña temporal
                    confirm_password: 'Hackless2025!',
                    rol: formData.get('rol'),
                    puesto: formData.get('puesto') || '',
                    area: formData.get('area') || '',
                    telefono: formData.get('telefono') || ''
                };
                
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(employeeData)
                });
                
                const result = await response.json();
                showManualResults(result, response.ok);
                
            } catch (error) {
                showManualResults({
                    message: 'Error de conexión: ' + error.message
                }, false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '👤 Crear Empleado';
            }
        }

        function showManualResults(result, success) {
            const resultsSection = document.getElementById('manualResultsSection');
            const resultsTitle = document.getElementById('manualResultsTitle');
            const resultsDetails = document.getElementById('manualResultsDetails');
            
            showElement('manualResultsSection');
            resultsSection.className = 'results-section ' + (success ? 'results-success' : 'results-error');
            
            if (success) {
                resultsTitle.textContent = '✅ Empleado Creado Exitosamente';
                resultsDetails.innerHTML = `
                    <p><strong>Mensaje:</strong> ${result.message}</p>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>🔑 Información importante:</strong><br>
                        El empleado ha sido registrado con la contraseña temporal: <strong>Hackless2025!</strong><br>
                        El empleado deberá cambiar esta contraseña en su primer login.
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>👤 Empleado registrado:</strong><br>
                        <strong>Nombre:</strong> ${result.usuario?.nombre || 'N/A'}<br>
                        <strong>Email:</strong> ${result.usuario?.correo_electronico || 'N/A'}<br>
                        <strong>Rol:</strong> ${result.usuario?.rol || 'N/A'}
                    </div>
                `;
            } else {
                resultsTitle.textContent = '❌ Error al Crear Empleado';
                resultsDetails.innerHTML = `
                    <p><strong>Error:</strong> ${result.message}</p>
                    <p>Por favor verifique los datos e intente nuevamente.</p>
                `;
            }
            
            // Ocultar formulario y preview
            hideElement('manualEmployeeForm');
            hideElement('manualPreview');
        }

        function resetManualForm() {
            // Mostrar formulario
            showElement('manualEmployeeForm');
            document.getElementById('manualEmployeeForm').reset();
            
            // Ocultar resultados y preview
            hideElement('manualResultsSection');
            hideElement('manualPreview');
        }

        // === FUNCIONES PARA DESCARGA DE PLANTILLAS ===
        function downloadTemplate() {
            // Crear CSV de plantilla
            const template = `Nombre,DNI,Email,Rol,Puesto,Area,Telefono
Juan Pérez,12345678,jperez@empresa.com,empleado,Ingeniero de Producción,Operaciones,+54 9 11 1234-5678
María González,87654321,mgonzalez@empresa.com,empleado,Técnica en Seguridad,HSE,+54 9 11 2345-6789`;
            
            downloadCSV(template, 'plantilla_empleados.csv');
        }

        function downloadSample() {
            // Descargar el archivo de ejemplo que creamos
            fetch('/empleados_ejemplo.csv')
                .then(response => response.text())
                .then(data => downloadCSV(data, 'empleados_ejemplo.csv'))
                .catch(() => {
                    // Si no existe, crear uno simple
                    const sample = `Nombre,DNI,Email,Rol,Puesto,Area,Telefono
Carlos Rodríguez,11223344,crodriguez@ejemplo.com,empleado,Supervisor de Campo,Operaciones,+54 9 11 3456-7890
Ana Martínez,44556677,amartinez@ejemplo.com,empleado,Coordinadora de Documentación,Administración,+54 9 11 4567-8901
Luis Fernández,77889900,lfernandez@ejemplo.com,empleado,Técnico en Mantenimiento,Mantenimiento,+54 9 11 5678-9012`;
                    downloadCSV(sample, 'empleados_ejemplo.csv');
                });
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === FUNCIONES PARA MODIFICAR Y ELIMINAR EMPLEADO ===
        async function buscarEmpleado() {
            const termino = document.getElementById('buscar_empleado').value.trim();
            
            if (!termino) {
                alert('Por favor ingrese un DNI o nombre para buscar');
                return;
            }

            try {
                const response = await fetch(`/api/empleados/buscar?termino=${encodeURIComponent(termino)}`);
                const data = await response.json();
                
                if (data.success && data.empleado) {
                    mostrarEmpleadoParaEdicion(data.empleado);
                } else {
                    alert('Empleado no encontrado');
                    document.getElementById('employee-edit-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error al buscar empleado:', error);
                alert('Error al buscar empleado');
            }
        }

        function mostrarEmpleadoParaEdicion(empleado) {
            const section = document.getElementById('employee-edit-section');
            
            // Llenar formulario con datos del empleado
            document.getElementById('edit_employee_id').value = empleado.id;
            document.getElementById('edit_nombre').value = empleado.nombre || '';
            document.getElementById('edit_dni').value = empleado.dni || '';
            document.getElementById('edit_email').value = empleado.email || '';
            document.getElementById('edit_rol').value = empleado.rol || '';
            document.getElementById('edit_puesto').value = empleado.puesto || '';
            document.getElementById('edit_area').value = empleado.area || '';
            document.getElementById('edit_telefono').value = empleado.telefono || '';
            document.getElementById('edit_estado').value = empleado.estado || 'activo';
            
            section.classList.remove('hidden');
        }

        function cancelarEdicion() {
            document.getElementById('employee-edit-section').classList.add('hidden');
            document.getElementById('buscar_empleado').value = '';
            document.getElementById('editEmployeeForm').reset();
        }

        // Manejar envío del formulario de edición
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('editEmployeeForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(editForm);
                    const employeeId = formData.get('employee_id');
                    
                    try {
                        const response = await fetch(`/api/empleados/${employeeId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                nombre: formData.get('nombre'),
                                dni: formData.get('dni'),
                                email: formData.get('email'),
                                rol: formData.get('rol'),
                                puesto: formData.get('puesto'),
                                area: formData.get('area'),
                                telefono: formData.get('telefono'),
                                estado: formData.get('estado')
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showAlert('Empleado actualizado exitosamente', 'success');
                            cancelarEdicion();
                        } else {
                            showAlert('Error al actualizar empleado: ' + data.message, 'danger');
                        }
                    } catch (error) {
                        console.error('Error al actualizar empleado:', error);
                        showAlert('Error al actualizar empleado', 'danger');
                    }
                });
            }
        });

        // === FUNCIONES PARA ELIMINAR EMPLEADO ===
        async function buscarEmpleadoEliminar() {
            const termino = document.getElementById('buscar_empleado_eliminar').value.trim();
            
            if (!termino) {
                alert('Por favor ingrese un DNI o nombre para buscar');
                return;
            }

            try {
                const response = await fetch(`/api/empleados/buscar?termino=${encodeURIComponent(termino)}`);
                const data = await response.json();
                
                if (data.success && data.empleado) {
                    mostrarEmpleadoParaEliminacion(data.empleado);
                } else {
                    alert('Empleado no encontrado');
                    document.getElementById('employee-delete-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error al buscar empleado:', error);
                alert('Error al buscar empleado');
            }
        }

        function mostrarEmpleadoParaEliminacion(empleado) {
            const section = document.getElementById('employee-delete-section');
            const infoDiv = document.getElementById('employee-delete-info');
            
            // Mostrar información del empleado
            infoDiv.innerHTML = `
                <div class="employee-info-display">
                    <p><strong>Nombre:</strong> ${empleado.nombre || 'N/A'}</p>
                    <p><strong>DNI:</strong> ${empleado.dni || 'N/A'}</p>
                    <p><strong>Email:</strong> ${empleado.email || 'N/A'}</p>
                    <p><strong>Rol:</strong> ${empleado.rol || 'N/A'}</p>
                    <p><strong>Puesto:</strong> ${empleado.puesto || 'N/A'}</p>
                    <p><strong>Estado:</strong> ${empleado.estado || 'N/A'}</p>
                </div>
            `;
            
            // Almacenar ID del empleado para eliminación
            window.employeeToDelete = empleado.id;
            
            section.classList.remove('hidden');
        }

        function cancelarEliminacion() {
            document.getElementById('employee-delete-section').classList.add('hidden');
            document.getElementById('buscar_empleado_eliminar').value = '';
            document.getElementById('confirm_delete').value = '';
            window.employeeToDelete = null;
        }

        async function confirmarEliminacion() {
            const confirmText = document.getElementById('confirm_delete').value.trim();
            
            if (confirmText !== 'ELIMINAR') {
                alert('Debe escribir exactamente "ELIMINAR" para confirmar');
                return;
            }
            
            if (!window.employeeToDelete) {
                alert('Error: No se ha seleccionado un empleado para eliminar');
                return;
            }
            
            try {
                const response = await fetch(`/api/empleados/${window.employeeToDelete}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Empleado eliminado exitosamente', 'success');
                    cancelarEliminacion();
                } else {
                    showAlert('Error al eliminar empleado: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error al eliminar empleado:', error);
                showAlert('Error al eliminar empleado', 'danger');
            }
        }

        // === FUNCIÓN PARA MOSTRAR ALERTAS ===
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 18px;">×</button>
                </div>
            `;
            
            alertsContainer.appendChild(alert);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
